<div class="container"> 
  <div class="align-content-center">
    <div class="row">
      <ng-container>
        <ngx-breadcrumb [breadcrumb]="breadcrumb"></ngx-breadcrumb>
        <div class="col-md-12 col-lg-12 col-xxxl-12">
          <p>Cadastrar</p>
          <div class="form-container">
            <form [formGroup]="form" (ngSubmit)="onSubmit()">
              <div class="form-row">
                <div class="form-group">
                  <label for="name">Gestão</label>
                  <input 
                    type="text" 
                    id="name" 
                    class="form-control" 
                    placeholder="Digite a gestão" 
                    formControlName="name"
                    [ngClass]="{'is-invalid': submitted && form.controls['name'].invalid}" />
                  <div *ngIf="submitted && form.controls['name'].invalid" class="invalid-feedback">
                    O campo gestão é obrigatório.
                  </div>
                </div>
                <div class="form-group">
                  <label for="description">Descrição</label>
                  <input 
                    type="text" 
                    id="description" 
                    class="form-control" 
                    placeholder="Digite a descrição" 
                    formControlName="description" 
                    [ngClass]="{'is-invalid': submitted && form.controls['description'].invalid}" />
                  <div *ngIf="submitted && form.controls['description'].invalid" class="invalid-feedback">
                    O campo descrição é obrigatório.
                  </div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="startYear">Início da Gestão</label>
                  <input 
                    type="number" 
                    id="startYear" 
                    class="form-control" 
                    placeholder="Ano" 
                    min="1000" 
                    max="9999" 
                    formControlName="startYear" 
                    [ngClass]="{'is-invalid': submitted && form.controls['startYear'].invalid}" />
                  <div *ngIf="submitted && form.controls['startYear'].invalid" class="invalid-feedback">
                    O campo início da gestão é obrigatório e deve ser um ano válido.
                  </div>
                </div>
                <div class="form-group">
                  <label for="endYear">Final da Gestão</label>
                  <input 
                    type="number" 
                    id="endYear" 
                    class="form-control" 
                    placeholder="Ano" 
                    min="1000" 
                    max="9999" 
                    formControlName="endYear" 
                    [ngClass]="{'is-invalid': submitted && form.controls['endYear'].invalid}" />
                  <div *ngIf="submitted && form.controls['endYear'].invalid" class="invalid-feedback">
                    O campo final da gestão é obrigatório e deve ser um ano válido.
                  </div>
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-danger" (click)="onCancel()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="organizer-container">
          <p>Estrutura</p>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Nome no Plural</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody>
              <tr class="new-structure-row">
                <td><input type="text" class="form-control" [(ngModel)]="newStructure.structureName" placeholder="Nome" /></td>
                <td><input type="text" class="form-control" [(ngModel)]="newStructure.namePlural" placeholder="Nome no Plural" /></td>
                <td class="text-center" >
                  <button class="btn btn-success btn-sm" (click)="addNewStructure()" *ngIf="structureList.length === 0">
                    <i class="fa fa-plus"></i>
                  </button>
                </td>
              </tr>
        
              <ng-container *ngFor="let item of structureList">
                <ng-template [ngTemplateOutlet]="renderItemStructure" [ngTemplateOutletContext]="{ item: item, parent: null }"></ng-template>
              </ng-container>
            </tbody>
          </table>
        
          <ng-template #renderItemStructure let-item="item" let-parent="parent" let-level="level">
            <tr [class.has-children]="item.children && item.children.length" [ngClass]="'child-level-' + level" class="first-item">
              <td>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="item.structureName"
                  placeholder="Nome"
                  [disabled]="!item.editable"
                />
              </td>
              <td>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="item.namePlural"
                  placeholder="Nome no Plural"
                  [disabled]="!item.editable"
                />
              </td>
              <td class="text-center">
                <button class="btn btn-primary btn-sm" (click)="structureToggleEditable(item)">
                  <i class="fa" [ngClass]="item.editable ? 'fa-check' : 'fa-pencil-alt'"></i>
                </button>
          
                <button class="btn btn-danger btn-sm" (click)="deleteItemStructure(parent || structureList, item)">
                  <i class="fa fa-trash"></i>
                </button>
                <button class="btn btn-success btn-sm" (click)="addChildStructure(item)">
                  <i class="fa fa-plus-circle"></i>
                </button>
              </td>
            </tr>
          
            <!-- Subitens -->
            <tr *ngIf="item.children && item.children.length">
              <td colspan="3" class="sub-item no-top-border">
                <table class="table table-striped">
                  <tbody>
                    <ng-container *ngFor="let child of item.children">
                      <ng-template [ngTemplateOutlet]="renderItemStructure" [ngTemplateOutletContext]="{ item: child, parent: item.children, level: (level || 0) + 1 }"></ng-template>
                    </ng-container>
                  </tbody>
                </table>
              </td>
            </tr>
          </ng-template>
        </div>

        <div class="organizer-container">
          <p>Organizador</p>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Descrição</th>
                <th>Estrutura</th>
                <th>Ícone</th>
                <th>Status</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody>
              <!-- Item em branco fixo no topo -->
              <tr>
                <td><input type="text" class="form-control" [(ngModel)]="newItem.name" placeholder="Nome" /></td>
                <td><input type="text" class="form-control" [(ngModel)]="newItem.description" placeholder="Descrição" /></td>
                <td>
                  <input type="text" class="form-control" [(ngModel)]="newItem.structureName" [disabled]="true" placeholder="Sem Estrutura" />
                </td>
                <td>
                  <select class="form-control" [(ngModel)]="newItem.icon">
                    <option value="">Selecionar</option>
                    <option *ngFor="let icon of iconList" [value]="icon">{{ icon }}</option>
                  </select>
                </td>
                <td>
                  <select class="form-control" [(ngModel)]="newItem.status">
                    <option value="">Selecionar</option>
                    <option value="Ativo">Ativo</option>
                    <option value="Inativo">Inativo</option>
                  </select>
                </td>
                <td class="text-center">
                  <button class="btn btn-success btn-sm" (click)="addNewItem()">
                    <i class="fa fa-plus"></i>
                  </button>
                </td>
              </tr>
        
              <!-- Lista de itens existentes -->
              <ng-container *ngFor="let item of organizerList">
                <ng-template [ngTemplateOutlet]="renderItem" [ngTemplateOutletContext]="{ item: item, parent: null }"></ng-template>
              </ng-container>
            </tbody>
          </table>
        
          <!-- Template para renderizar itens (recursivo) -->
          <ng-template #renderItem let-item="item" let-parent="parent" let-level="level">
            <tr [class.has-children]="item.children && item.children.length" [ngClass]="'child-level-' + level" class="first-item">
              <td>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="item.name"
                  placeholder="Nome"
                  [disabled]="!item.editable" />
              </td>
              <td>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="item.description"
                  placeholder="Descrição"
                  [disabled]="!item.editable" />
              </td>
              <td>
                <input
                type="text"
                class="form-control"
                [(ngModel)]="item.structureName"
                [disabled]="true" />
              </td>
              <td>
                <select class="form-control" [(ngModel)]="item.icon" [disabled]="!item.editable">
                  <option value="">Selecionar</option>
                  <option *ngFor="let icon of iconList" [value]="icon">{{ icon }}</option>
                </select>
              </td>
              <td>
                <select class="form-control" [(ngModel)]="item.status" [disabled]="!item.editable">
                  <option value="">Selecionar</option>
                  <option value="Ativo">Ativo</option>
                  <option value="Inativo">Inativo</option>
                </select>
              </td>
              <td class="text-center"> <!-- Alinha todos os ícones ao centro -->
                <!-- Botão de Editar/Salvar (Lápis ou Check) -->
                <button
                  class="btn btn-primary btn-sm"
                  (click)="toggleEditable(item)"
                  [title]="item.editable ? 'Salvar' : 'Editar'">
                  <i class="fa" [ngClass]="item.editable ? 'fa-check' : 'fa-pencil-alt'"></i> <!-- Lápis ou Check -->
                </button>
        
                <!-- Botão de Excluir (Lixeira) -->
                <button
                  class="btn btn-danger btn-sm"
                  (click)="deleteItem(parent || organizerList, item)"
                  title="Excluir">
                  <i class="fa fa-trash"></i> <!-- Lixeira -->
                </button>
        
                <button
                  *ngIf="hasChildren(item.structureName)"
                  class="btn btn-success btn-sm"
                  (click)="addChild(item)"
                  title="Adicionar Subitem"
                >
                  <i class="fa fa-plus-circle"></i>
                </button>
              </td>
            </tr>
        
            <!-- Subitens -->
            <tr *ngIf="item.children && item.children.length">
              <td colspan="6" class="sub-item no-top-border">
                <table class="table table-striped">
                  <tbody>
                    <ng-container *ngFor="let child of item.children">
                      <ng-template [ngTemplateOutlet]="renderItem" [ngTemplateOutletContext]="{ item: child, parent: item.children, level: (level || 0) + 1 }"></ng-template>
                    </ng-container>
                  </tbody>
                </table>
              </td>
            </tr>
          </ng-template>
          <div class="text-center">
            <button class="btn btn-success" (click)="saveItems()">Salvar Itens</button>
          </div>
        </div>
        
        
      </ng-container>
    </div>
  </div>
</div>
